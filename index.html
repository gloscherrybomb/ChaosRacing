<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>British National Circuit Series - General Classification</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Georgia', 'Times New Roman', serif;
            background: linear-gradient(135deg, #f4f1e8 0%, #e8dcc0 50%, #f4f1e8 100%);
            min-height: 100vh;
            color: #2c3e50;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(44, 95, 95, 0.1);
            backdrop-filter: blur(10px);
            border: 3px solid #2c5f5f;
            overflow: hidden;
        }
        
        .header-image {
            width: 20%;
            height: auto;
            display: block;
            border-radius: 12px;
            object-fit: contain;
            margin: 0 auto;
        }
        
        .header-upload-area {
            background: linear-gradient(135deg, #f4f1e8 0%, #e8dcc0 100%);
            border: 3px dashed #2c5f5f;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            transition: all 0.3s ease;
            width: 20%;
            margin: 0 auto;
            min-width: 300px;
        }
        
        #headerImageContainer {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .header-upload-area:hover {
            background: linear-gradient(135deg, #e8dcc0 0%, #d4c8a8 100%);
            border-color: #c0392b;
        }
        
        .header-upload-label {
            display: inline-block;
            padding: 15px 30px;
            background: #2c5f5f;
            color: #f4f1e8;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
        }
        
        .header-upload-label:hover {
            background: #1e4040;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(44, 95, 95, 0.4);
        }
        
        .header-content {
            display: flex;
            align-items: center;
            gap: 30px;
            padding: 30px;
        }
        
        .header h1 {
            font-size: 2.2rem;
            color: #2c5f5f;
            margin-bottom: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .header p {
            font-size: 1.1rem;
            color: #c0392b;
            margin-bottom: 20px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .file-input-section {
            background: rgba(44, 95, 95, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid rgba(44, 95, 95, 0.2);
        }
        
        .file-input-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            align-items: center;
        }
        
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        
        .file-input {
            position: absolute;
            left: -9999px;
            opacity: 0;
        }
        
        .file-input-label {
            display: inline-block;
            padding: 12px 25px;
            background: #2c5f5f;
            color: #f4f1e8;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .file-input-label:hover {
            background: #1e4040;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(44, 95, 95, 0.4);
        }
        
        .status-message {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 600;
            display: none;
        }
        
        .status-success {
            background: rgba(46, 125, 50, 0.2);
            color: #2e7d32;
            border: 2px solid rgba(46, 125, 50, 0.3);
        }
        
        .status-error {
            background: rgba(192, 57, 43, 0.2);
            color: #c0392b;
            border: 2px solid rgba(192, 57, 43, 0.3);
        }
        
        .rank-tabs {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
        }
        
        .tab-button {
            padding: 15px 25px;
            background: rgba(244, 241, 232, 0.9);
            border: 2px solid #2c5f5f;
            border-radius: 8px;
            color: #2c5f5f;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Georgia', serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .tab-button:hover {
            background: rgba(44, 95, 95, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(44, 95, 95, 0.2);
        }
        
        .tab-button.active {
            background: #2c5f5f;
            color: #f4f1e8;
            box-shadow: 0 5px 20px rgba(44, 95, 95, 0.3);
        }
        
        .tab-content {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(44, 95, 95, 0.1);
            backdrop-filter: blur(10px);
            border: 3px solid #2c5f5f;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .filters-container {
            margin-bottom: 25px;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        
        .filter-label {
            font-weight: 600;
            color: #2c5f5f;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .search-input, .filter-select {
            padding: 12px 20px;
            border: 2px solid #2c5f5f;
            border-radius: 8px;
            font-size: 16px;
            font-family: 'Georgia', serif;
            outline: none;
            transition: all 0.3s ease;
            background: #f4f1e8;
            color: #2c3e50;
        }
        
        .search-input {
            width: 300px;
            max-width: 100%;
        }
        
        .filter-select {
            width: 150px;
            cursor: pointer;
        }
        
        .search-input:focus, .filter-select:focus {
            border-color: #c0392b;
            box-shadow: 0 0 0 3px rgba(192, 57, 43, 0.1);
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(44, 95, 95, 0.15);
            border: 2px solid #2c5f5f;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 900px;
        }
        
        th {
            background: linear-gradient(135deg, #2c5f5f 0%, #1e4040 100%);
            color: #f4f1e8;
            padding: 20px 15px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            position: relative;
            user-select: none;
            font-family: 'Georgia', serif;
        }
        
        th:hover {
            background: linear-gradient(135deg, #1e4040 0%, #2c5f5f 100%);
        }
        
        th.sortable::after {
            content: " ↕";
            opacity: 0.5;
            font-size: 12px;
            color: #c0392b;
        }
        
        th.sort-asc::after {
            content: " ↑";
            opacity: 1;
            color: #c0392b;
        }
        
        th.sort-desc::after {
            content: " ↓";
            opacity: 1;
            color: #c0392b;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid #e8dcc0;
            font-size: 14px;
            font-family: 'Georgia', serif;
        }
        
        tr:nth-child(even) {
            background: rgba(232, 220, 192, 0.3);
        }
        
        tr:hover {
            background: rgba(44, 95, 95, 0.05);
        }
        
        .position-cell {
            font-weight: bold;
            font-size: 18px;
            color: #2c5f5f;
            text-align: center;
            width: 60px;
        }
        
        .position-1 { 
            color: #f1c40f; 
            background: rgba(241, 196, 15, 0.1);
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            font-weight: 800;
        }
        .position-2 { 
            color: #95a5a6; 
            background: rgba(149, 165, 166, 0.1);
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            font-weight: 800;
        }
        .position-3 { 
            color: #e67e22; 
            background: rgba(230, 126, 34, 0.1);
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            font-weight: 800;
        }
        
        .name-cell {
            font-weight: 600;
            color: #2c5f5f;
        }
        
        .delta-cell {
            font-family: 'Courier New', monospace;
            font-weight: 500;
            color: #c0392b;
        }
        
        .missed-rounds {
            background: linear-gradient(135deg, #c0392b, #a93226);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .no-missed {
            color: #2e7d32;
            font-weight: 600;
        }
        
        .gender-male {
            color: #2980b9;
            font-weight: 600;
        }
        
        .gender-female {
            color: #8e44ad;
            font-weight: 600;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px;
            color: #2c5f5f;
            font-size: 18px;
        }
        
        .instructions {
            background: rgba(44, 95, 95, 0.1);
            border: 2px solid rgba(44, 95, 95, 0.2);
            color: #2c5f5f;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .results-summary {
            background: linear-gradient(135deg, #c0392b, #a93226);
            color: #f4f1e8;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .header h1 { font-size: 1.8rem; }
            .header p { font-size: 1rem; }
            .search-input { width: 250px; }
            .filter-select { width: 120px; }
            th, td { padding: 10px 8px; font-size: 12px; }
            .tab-button { padding: 12px 20px; font-size: 14px; }
            .filters-container { gap: 10px; }
            .filter-group { margin-bottom: 10px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <!-- Header image area -->
                <div id="headerImageContainer">
                    <img id="headerImage" class="header-image" style="display: none;" />
                    <div id="headerUploadArea" class="header-upload-area">
                        <input type="file" id="headerImageInput" accept="image/*" style="display: none;" />
                        <label for="headerImageInput" class="header-upload-label">
                            📸 Upload Header
                        </label>
                        <p style="margin-top: 8px; opacity: 0.8; font-size: 12px;">Click to add your image</p>
                    </div>
                </div>

                <!-- Header text area -->
                <div class="header-text">
                    <h1>General Classification Results</h1>
                    
                    <div class="file-input-section">
                        <div class="file-input-container">
                            <div class="file-input-wrapper">
                                <input type="file" id="csvFiles" class="file-input" multiple accept=".csv" />
                                <label for="csvFiles" class="file-input-label">📁 Load CSV Files</label>
                            </div>
                        </div>
                        <div class="status-message" id="statusMessage"></div>
                    </div>
                    
                    <div class="instructions">
                        <strong>How to use:</strong> 
                        <br>1. Upload your header image (left)
                        <br>2. Load your CSV files above
                        <br>3. Filter and explore results below
                    </div>
                </div>
            </div>
        </div>

        <div class="rank-tabs" id="rankTabs" style="display: none;"></div>

        <div id="tabContents"></div>

        <div class="empty-state" id="emptyState">
            <h3>👆 Load your CSV files to view the general classification results</h3>
            <p>Select multiple CSV files generated by your race results processor</p>
        </div>
    </div>

    <script>
        let loadedData = {};
        let currentSort = {};

        document.getElementById('csvFiles').addEventListener('change', handleFileLoad);
        document.getElementById('headerImageInput').addEventListener('change', handleHeaderImageLoad);

        async function handleHeaderImageLoad(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const headerContainer = document.getElementById('headerImageContainer');
                    const uploadArea = document.getElementById('headerUploadArea');
                    
                    // Set the background image
                    headerContainer.style.backgroundImage = `url(${e.target.result})`;
                    
                    // Hide the upload area completely
                    uploadArea.classList.add('hidden');
                    
                    console.log('Image loaded and background set'); // Debug
                };
                reader.readAsDataURL(file);
            } catch (error) {
                console.error('Error loading header image:', error);
            }
        }

        async function handleFileLoad(event) {
            const files = event.target.files;
            if (files.length === 0) return;

            const statusMessage = document.getElementById('statusMessage');
            statusMessage.className = 'status-message';
            statusMessage.style.display = 'block';
            statusMessage.textContent = 'Loading files...';

            try {
                loadedData = {};
                
                for (let file of files) {
                    const text = await readFileAsText(file);
                    const data = parseCSV(text);
                    
                    if (data.length > 0) {
                        // Extract rank from filename (e.g., GC_Diamond.csv -> Diamond)
                        const rankMatch = file.name.match(/GC_(.+)\.csv/i);
                        const rank = rankMatch ? rankMatch[1].replace('_', ' ') : file.name.replace('.csv', '');
                        
                        loadedData[rank] = data;
                    }
                }

                if (Object.keys(loadedData).length > 0) {
                    displayResults();
                    statusMessage.className = 'status-message status-success';
                    statusMessage.textContent = `✅ Successfully loaded ${Object.keys(loadedData).length} classification(s)`;
                    setTimeout(() => {
                        statusMessage.style.display = 'none';
                    }, 3000);
                } else {
                    throw new Error('No valid data found in files');
                }

            } catch (error) {
                statusMessage.className = 'status-message status-error';
                statusMessage.textContent = `❌ Error loading files: ${error.message}`;
            }
        }

        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = e => reject(new Error('Failed to read file'));
                reader.readAsText(file);
            });
        }

        function parseCSV(text) {
            const lines = text.trim().split('\n');
            if (lines.length < 2) return [];

            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length === headers.length) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index];
                    });
                    data.push(row);
                }
            }

            return data;
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim().replace(/"/g, ''));
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim().replace(/"/g, ''));
            return result;
        }

        function displayResults() {
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('rankTabs').style.display = 'flex';

            const tabsContainer = document.getElementById('rankTabs');
            const contentsContainer = document.getElementById('tabContents');
            
            tabsContainer.innerHTML = '';
            contentsContainer.innerHTML = '';

            // Sort ranks by typical cycling hierarchy
            const rankOrder = ['Diamond', 'Platinum', 'Gold', 'Silver', 'Bronze', 'Carbon'];
            const sortedRanks = Object.keys(loadedData).sort((a, b) => {
                const aIndex = rankOrder.findIndex(r => a.toLowerCase().includes(r.toLowerCase()));
                const bIndex = rankOrder.findIndex(r => b.toLowerCase().includes(r.toLowerCase()));
                
                if (aIndex === -1 && bIndex === -1) return a.localeCompare(b);
                if (aIndex === -1) return 1;
                if (bIndex === -1) return -1;
                return aIndex - bIndex;
            });

            // Create tabs and content
            sortedRanks.forEach((rank, index) => {
                // Create tab button
                const tabButton = document.createElement('button');
                tabButton.className = `tab-button ${index === 0 ? 'active' : ''}`;
                tabButton.textContent = `${getRankEmoji(rank)} ${rank} (${loadedData[rank].length})`;
                tabButton.onclick = () => switchTab(rank);
                tabsContainer.appendChild(tabButton);

                // Get unique age bands for this rank
                const ageBands = [...new Set(loadedData[rank]
                    .map(rider => rider.AgeBand)
                    .filter(age => age && age.trim() !== '')
                )].sort();

                // Create age band options
                const ageBandOptions = ageBands.map(age => 
                    `<option value="${age}">${age}</option>`
                ).join('');

                // Create tab content
                const tabContent = document.createElement('div');
                tabContent.className = `tab-content ${index === 0 ? 'active' : ''}`;
                tabContent.id = `tab-${rank}`;
                
                tabContent.innerHTML = `
                    <div class="results-summary">
                        ${rank} Classification - ${loadedData[rank].length} Riders
                    </div>
                    <div class="filters-container">
                        <div class="filter-group">
                            <label class="filter-label">Search</label>
                            <input type="text" class="search-input" placeholder="🔍 Search riders..." 
                                   oninput="filterTable('${rank}', this.value, getGenderFilter('${rank}'), getAgeBandFilter('${rank}'))">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Gender</label>
                            <select class="filter-select gender-filter" 
                                    onchange="filterTable('${rank}', getSearchValue('${rank}'), this.value, getAgeBandFilter('${rank}'))">
                                <option value="">All</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Age Group</label>
                            <select class="filter-select ageband-filter" 
                                    onchange="filterTable('${rank}', getSearchValue('${rank}'), getGenderFilter('${rank}'), this.value)">
                                <option value="">All Ages</option>
                                ${ageBandOptions}
                            </select>
                        </div>
                    </div>
                    <div class="table-container">
                        ${createTable(rank, loadedData[rank])}
                    </div>
                `;
                
                contentsContainer.appendChild(tabContent);
            });
        }

        function getRankEmoji(rank) {
            const rankLower = rank.toLowerCase();
            if (rankLower.includes('diamond')) return '💎';
            if (rankLower.includes('platinum')) return '🥈';
            if (rankLower.includes('gold')) return '🥇';
            if (rankLower.includes('silver')) return '🥈';
            if (rankLower.includes('bronze')) return '🥉';
            if (rankLower.includes('carbon')) return '⚫';
            return '🏆';
        }

        function createTable(rank, data) {
            if (data.length === 0) {
                return '<div class="empty-state"><h3>No data available</h3></div>';
            }

            const headers = Object.keys(data[0]);
            const visibleHeaders = headers.filter(h => 
                !['UID', 'EventKey', 'Round'].includes(h)
            );

            let tableHTML = `<table id="table-${rank}">
                <thead>
                    <tr>`;

            visibleHeaders.forEach(header => {
                const sortable = ['Position', 'TotalDeltaTime', 'RoundsCompleted', 'MissedRounds', 'AverageDeltaTime'].includes(header);
                tableHTML += `<th class="${sortable ? 'sortable' : ''}" 
                              ${sortable ? `onclick="sortTable('${rank}', '${header}')"` : ''}>${header}</th>`;
            });

            tableHTML += `</tr></thead><tbody>`;

            data.forEach(row => {
                tableHTML += '<tr>';
                visibleHeaders.forEach(header => {
                    let cellContent = row[header] || '';
                    let cellClass = '';

                    if (header === 'Position') {
                        cellClass = 'position-cell';
                        if (cellContent === '1') cellClass += ' position-1';
                        else if (cellContent === '2') cellClass += ' position-2';
                        else if (cellContent === '3') cellClass += ' position-3';
                    } else if (header === 'Name') {
                        cellClass = 'name-cell';
                    } else if (header === 'Gender') {
                        cellClass = cellContent.toLowerCase() === 'male' ? 'gender-male' : 'gender-female';
                    } else if (header === 'TotalDeltaTime' || header === 'AverageDeltaTime') {
                        cellClass = 'delta-cell';
                        if (cellContent && !isNaN(cellContent)) {
                            cellContent = parseFloat(cellContent).toFixed(3) + 's';
                        }
                    } else if (header === 'MissedRounds') {
                        if (cellContent === '0' || cellContent === '') {
                            cellContent = '<span class="no-missed">0</span>';
                        } else {
                            cellContent = `<span class="missed-rounds">${cellContent}</span>`;
                        }
                    }

                    tableHTML += `<td class="${cellClass}">${cellContent}</td>`;
                });
                tableHTML += '</tr>';
            });

            tableHTML += '</tbody></table>';
            return tableHTML;
        }

        function switchTab(rank) {
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab contents
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`tab-${rank}`).classList.add('active');
        }

        function sortTable(rank, column) {
            const data = loadedData[rank];
            const table = document.getElementById(`table-${rank}`);
            const header = table.querySelector(`th[onclick*="${column}"]`);
            
            // Determine sort direction
            let ascending = true;
            if (currentSort[rank] === column + '_asc') {
                ascending = false;
                currentSort[rank] = column + '_desc';
            } else {
                currentSort[rank] = column + '_asc';
            }

            // Clear all sort indicators
            table.querySelectorAll('th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });

            // Add sort indicator
            header.classList.add(ascending ? 'sort-asc' : 'sort-desc');

            // Sort data
            data.sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];

                // Convert to numbers if possible
                if (!isNaN(aVal) && !isNaN(bVal)) {
                    aVal = parseFloat(aVal);
                    bVal = parseFloat(bVal);
                } else {
                    aVal = String(aVal).toLowerCase();
                    bVal = String(bVal).toLowerCase();
                }

                if (aVal < bVal) return ascending ? -1 : 1;
                if (aVal > bVal) return ascending ? 1 : -1;
                return 0;
            });

            // Refresh table
            const tableContainer = document.querySelector(`#tab-${rank} .table-container`);
            tableContainer.innerHTML = createTable(rank, data);
        }

        function filterTable(rank, searchTerm, genderFilter, ageBandFilter) {
            const table = document.getElementById(`table-${rank}`);
            const rows = table.querySelectorAll('tbody tr');
            let visibleCount = 0;
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowText = row.textContent.toLowerCase();
                const nameCell = cells[1]; // Name column
                const genderCell = cells[4]; // Gender column  
                const ageBandCell = cells[cells.length - 1]; // AgeBand is last column
                
                // Check search term
                const matchesSearch = !searchTerm || rowText.includes(searchTerm.toLowerCase());
                
                // Check gender filter
                const matchesGender = !genderFilter || (genderCell && genderCell.textContent.trim() === genderFilter);
                
                // Check age band filter
                const matchesAge = !ageBandFilter || (ageBandCell && ageBandCell.textContent.trim() === ageBandFilter);
                
                const shouldShow = matchesSearch && matchesGender && matchesAge;
                row.style.display = shouldShow ? '' : 'none';
                
                if (shouldShow) visibleCount++;
            });
            
            // Update the results summary
            const summary = document.querySelector(`#tab-${rank} .results-summary`);
            if (summary) {
                const totalCount = loadedData[rank].length;
                if (visibleCount === totalCount) {
                    summary.textContent = `${rank} Classification - ${totalCount} Riders`;
                } else {
                    summary.textContent = `${rank} Classification - ${visibleCount} of ${totalCount} Riders`;
                }
            }
        }
        
        function getSearchValue(rank) {
            const searchInput = document.querySelector(`#tab-${rank} .search-input`);
            return searchInput ? searchInput.value : '';
        }
        
        function getGenderFilter(rank) {
            const genderSelect = document.querySelector(`#tab-${rank} .gender-filter`);
            return genderSelect ? genderSelect.value : '';
        }
        
        function getAgeBandFilter(rank) {
            const ageBandSelect = document.querySelector(`#tab-${rank} .ageband-filter`);
            return ageBandSelect ? ageBandSelect.value : '';
        }
    </script>
</body>
</html>
